/*! ArcGIS API for JavaScript 4.9 | Copyright (c) 2018 Esri. All rights reserved. | http://www.esri.com/legal/privacy | https://developers.arcgis.com/terms/faq */
define(["dojo/Stateful","dojo/_base/declare","dojo/_base/lang","esri/core/HandleRegistry","esri-playground-js/utils/CodeGenerator","esri-playground-js/utils/ObjectProvider"],function(e,n,t,s,c,i){var o={},r=n([e],{ast:null,config:null,editor:null,statefulObject:null,view:null}),l=function(e){var n=o._instance.config&&o._instance.config.className;if(n){var t=JSON.parse(sessionStorage.getItem(n))||{};t[e]=o._instance.get(e),sessionStorage.setItem(n,JSON.stringify(t))}},u=function(e,n){for(var t in n)n[t]instanceof Array?e.set(t,n[t]):n[t]instanceof Object?u(e[t],n[t]):null!=n[t]&&"className"!==t&&e.set(t,n[t])},d=function(s,e){for(var n in e)e[n]instanceof i.StatefulClass&&d(s,e[n]);var t=e.watch(function(e,n,t){if(n!=t){Array.isArray(t)&&"color"!==e?t.forEach(function(e){e instanceof i.StatefulClass&&d(s,e)}):t instanceof i.StatefulClass&&d(s,t);var a=c.constructAST(o._instance);o._instance.set("ast",a),l("statefulObject")}});o._instance.handles.add(t,"obj-watch")};return o.getInstance=function(){if(!o._instance){o._instance=new r,o._instance.handles=new s,o._instance.required={paths:[],reqModules:[],commentReqModules:["// Modules required: "],reqVariables:[]};var e=o._instance.watch("ast",function(){var e=o._instance.get("ast");if(e){var n=o._instance.get("config"),t=n.autocastType;if(t){var a=c.getAutocastAST(n.variable,t,e),s=c.generateCode(a);o._instance.editor.getDoc().setValue("// autocasts as new "+n.className+"() \n\n"+js_beautify(s))}else{var i=c.generateCode(e);i=o._instance.required.commentReqModules.join("\n")+"\n\n"+js_beautify(i),o._instance.editor.getDoc().setValue(i)}l("ast")}});o._instance.handles.add(e,"ast-handler");var n=o._instance.watch("config",function(){l("config")});o._instance.handles.add(n,"config-handler");var t=o._instance.watch("statefulObject",function(){d(o._instance.config,o._instance.statefulObject);var e=JSON.parse(sessionStorage.getItem(o._instance.config.className)),n=window.location.hash.split("?")[1],t=n&&JSON.parse(decodeURIComponent(n.split("=")[1]));if(t||e&&e.statefulObject){u(o._instance.statefulObject,t||e.statefulObject);var a=c.constructAST(o._instance);o._instance.set("ast",a)}if(t){var s=window.location.hash;window.location.hash=s.split("?")[0]}});o._instance.handles.add(t,"stateful-handler");var a=o._instance.watch("required",function(){});o._instance.handles.add(a,"required-handler")}return o._instance},o.destroy=function(){o._instance.handles.destroy(),o._instance.handles=null,o._instance.required=null,o._instance=null},o});